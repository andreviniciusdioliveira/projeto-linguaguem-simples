<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔹 Agente de Linguagem Simples</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/5356/5356211.png" type="image/png">
</head>
<body>
    <!-- Switch para modo escuro -->
    <div class="switch-container">
        <label class="switch">
            <input type="checkbox" id="themeSwitch">
            <span class="slider"></span>
        </label>
    </div>

    <div class="container">
        <h1>🔹 Agente de Linguagem Simples</h1>
        <p class="api-indicator">Usando API: ChatGPT (OpenAI)</p>

        <!-- Envio de PDF -->
        <h2>Enviar PDF</h2>
        <div id="drop-area">
            <p>Arraste e solte seu PDF aqui ou clique para selecionar</p>
            <input type="file" id="fileElem" accept="application/pdf" style="display:none">
            <label class="button" for="fileElem">Selecionar PDF</label>
        </div>

        <!-- Texto Manual -->
        <h2>Ou Colar Texto Manualmente</h2>
        <textarea id="manualText" placeholder="Cole aqui o texto que deseja simplificar..." rows="6"></textarea>
        <div class="manual-buttons">
            <button class="button" onclick="processManualText()">Simplificar Texto</button>
            <button class="button clear" onclick="clearAll()">🧹 Limpar Tudo</button>
        </div>

        <div id="loading">Simplificando, aguarde...</div>
        <div id="erroMsg"></div>

        <!-- Resultado -->
        <div id="output">
            <div id="textoSimplificado" class="output-text"></div>
            <div class="result-buttons">
                <a id="downloadLink" class="button download-animate" style="display:none" download="pdf_simplificado.pdf">Baixar PDF Simplificado</a>
                <button class="button" id="copyButton" style="display:none" onclick="copyText()">📋 Copiar Resultado</button>
            </div>
        </div>

        <!-- Avatar -->
        <div id="avatarContainer" class="avatar-animate">
            <iframe id="avatarFrame"
                    src="https://my.readyplayer.me/avatar?frameApi"
                    allow="camera *; microphone *"
                    style="width:300px;height:400px;border:none;">
            </iframe>
            <button class="button" id="speakButton" onclick="toggleSpeak()">🔊 Ler em voz alta</button>
        </div>
    </div>

    <!-- Toast notifications -->
    <div id="toast"></div>
    <audio id="toastSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

    <script>
        // ---- Tema escuro/claro ----
        const themeSwitch = document.getElementById('themeSwitch');
        themeSwitch.addEventListener('change', () => {
            document.body.classList.toggle('dark-mode', themeSwitch.checked);
        });

        // ---- Leitura em voz alta ----
        let isSpeaking = false;
        let synth = window.speechSynthesis;
        function toggleSpeak() {
            const button = document.getElementById("speakButton");
            if (isSpeaking) {
                synth.cancel();
                button.innerText = "🔊 Ler em voz alta";
                isSpeaking = false;
            } else {
                let text = document.getElementById('textoSimplificado').innerText;
                if (!text) return;
                let utter = new SpeechSynthesisUtterance(text);
                utter.lang = "pt-BR";
                utter.onend = () => {
                    button.innerText = "🔊 Ler em voz alta";
                    isSpeaking = false;
                };
                synth.speak(utter);
                button.innerText = "⏹ Parar leitura";
                isSpeaking = true;
            }
        }

        // ---- Toast Notifications ----
        function showToast(message, type = "info") {
            const toast = document.getElementById("toast");
            const toastSound = document.getElementById("toastSound");
            toast.innerText = message;
            toast.className = "show " + type;
            toastSound.play();
            setTimeout(() => {
                toast.className = toast.className.replace("show", "");
            }, 3500);
        }

        // ---- Limpar tudo ----
        function clearAll() {
            document.getElementById("manualText").value = "";
            document.getElementById("textoSimplificado").innerText = "";
            document.getElementById("output").classList.remove("show");
            document.getElementById("downloadLink").style.display = "none";
            document.getElementById("copyButton").style.display = "none";
            showToast("Tudo limpo!", "info");
        }

        // ---- Copiar texto ----
        function copyText() {
            let text = document.getElementById("textoSimplificado").innerText;
            if (!text) {
                showToast("Não há texto para copiar!", "error");
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                showToast("Texto copiado para a área de transferência!", "success");
            }).catch(() => {
                showToast("Erro ao copiar texto.", "error");
            });
        }

        // ---- Processar texto manual ----
        function processManualText() {
            let text = document.getElementById("manualText").value.trim();
            if (!text) {
                showToast("Cole um texto para simplificar!", "error");
                return;
            }
            document.getElementById("loading").style.display = "block";
            fetch("/processar_texto", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ texto: text })
            })
            .then(res => res.json().then(data => ({status: res.status, body: data})))
            .then(result => {
                document.getElementById("loading").style.display = "none";
                if (result.status !== 200) {
                    showToast(result.body.erro || "Erro ao processar o texto.", "error");
                    return;
                }
                document.getElementById("textoSimplificado").innerText = result.body.texto;
                document.getElementById("output").classList.add("show");
                document.getElementById("copyButton").style.display = "inline-block";
                showToast("Texto simplificado com sucesso!", "success");
            })
            .catch(() => {
                document.getElementById("loading").style.display = "none";
                showToast("Erro de comunicação com servidor.", "error");
            });
        }

        // ---- Drag & Drop PDF ----
        let dropArea = document.getElementById('drop-area');
        let fileInput = document.getElementById('fileElem');

        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('hover');
        });
        dropArea.addEventListener('dragleave', () => dropArea.classList.remove('hover'));
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('hover');
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', () => handleFiles(fileInput.files));

        function handleFiles(files) {
            if (files.length > 0) {
                uploadFile(files[0]);
            }
        }

        function uploadFile(file) {
            document.getElementById("loading").style.display = "block";
            document.getElementById("erroMsg").style.display = "none";
            let formData = new FormData();
            formData.append("file", file);
            fetch("/processar", { method: "POST", body: formData })
                .then(res => res.json().then(data => ({status: res.status, body: data})))
                .then(result => {
                    document.getElementById("loading").style.display = "none";
                    if (result.status !== 200) {
                        showToast(result.body.erro || "Erro desconhecido ao processar o PDF.", "error");
                        return;
                    }
                    document.getElementById("textoSimplificado").innerText = result.body.texto;
                    document.getElementById("output").classList.add("show");
                    let link = document.getElementById("downloadLink");
                    link.href = "/download_pdf";
                    link.style.display = "inline-block";
                    document.getElementById("copyButton").style.display = "inline-block";
                    link.classList.add('pulse');
                    setTimeout(() => link.classList.remove('pulse'), 1000);
                    showToast("PDF simplificado com sucesso!", "success");
                })
                .catch(() => {
                    document.getElementById("loading").style.display = "none";
                    showToast("Erro ao enviar ou processar o PDF.", "error");
                });
        }
    </script>
</body>
</html>
